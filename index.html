<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>互動式柯本氣候學習平台</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js for interactive maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Chart.js for climographs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Custom font and base styling */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        #map {
            height: 100%; /* Map will fill its container's height */
            width: 100%;
            cursor: grab;
            background-color: #1e293b; /* A dark background for satellite tiles */
        }
        /* Custom styles for Leaflet legend */
        .legend {
            padding: 0; /* Remove padding for header */
            font: 13px/1.5 'Noto Sans TC', Arial, Helvetica, sans-serif;
            background: rgba(255,255,255,0.85);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 8px;
            color: #333;
            max-height: 40vh; /* Set a max-height for mobile */
            overflow-y: auto;
        }
        /* Draggable header for the legend */
        .legend-header {
            padding: 6px 12px;
            font-weight: bold;
            font-size: 14px;
            background-color: rgba(0, 0, 0, 0.1);
            cursor: move;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        .legend-content {
            padding: 8px 12px;
            line-height: 20px;
        }
        .legend h4 {
            font-weight: bold;
            margin: 8px 0 5px 0;
            font-size: 14px;
        }
        .legend h4:first-child {
            margin-top: 0;
        }
        .legend i {
            width: 16px; 
            height: 16px; 
            float: left;
            margin-right: 8px;
            opacity: 0.8; 
            border-radius: 4px;
        }
        /* Custom class for enlarged city labels */
        .city-label-tooltip {
            font-size: 14px !important;
            font-weight: 500;
            padding: 4px 8px;
            background-color: rgba(255, 255, 255, 0.9);
            border-color: rgba(0,0,0,0.2);
        }
        /* Style for selected city in dropdown */
        select option:checked {
            background-color: #3b82f6;
            color: #ffffff;
        }
        /* Style for the analysis box */
        .analysis-box {
            margin-top: 1rem;
            border-radius: 0.375rem;
            padding: 0.75rem;
            background-color: #f3f4f6;
            border-left: 4px solid #3b82f6;
            font-size: 0.875rem;
            line-height: 1.5;
            color: #374151;
        }
        .analysis-box h5 {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #1f2937;
        }
        /* Quiz Styles */
        .quiz-option {
            display: block;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .quiz-option:hover {
            background-color: #f9fafb;
        }
        .quiz-option.selected {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }
        /* Style for latitude line labels */
        .lat-label {
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            border: none;
            box-shadow: none;
        }
        /* Tab styles */
        .tab-button {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border: 1px solid #d1d5db;
            border-bottom: none;
            background-color: #f9fafb;
            color: #374151;
            font-weight: 500;
        }
        .tab-button.active {
            background-color: #ffffff;
            border-bottom: 1px solid #ffffff;
            color: #3b82f6;
        }
        /* Slider Styles */
        .slider-container {
            display: grid;
            grid-template-columns: 40px 1fr 50px;
            gap: 10px;
            align-items: center;
            margin-bottom: 4px;
        }
        /* Help button and explanation box styles */
        .explanation-box {
            background-color: #eef2ff;
            border-left: 4px solid #6366f1;
            padding: 10px;
            margin-top: 8px;
            border-radius: 4px;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100">

    <!-- Responsive Flex Container -->
    <div class="flex flex-col lg:flex-row">
        <!-- Map container -->
        <div class="w-full lg:w-2/3 h-96 lg:h-screen">
            <div id="map"></div>
        </div>

        <!-- Information and Climograph Panel -->
        <div class="w-full lg:w-1/3 bg-white shadow-lg overflow-y-auto lg:h-screen">
            <div class="p-6">
                 <h1 class="text-2xl font-bold text-gray-800 mb-4">互動式柯本氣候學習平台</h1>
                
                <!-- Tab Navigation -->
                <div class="flex border-b border-gray-300 mb-4">
                    <button id="tab-main" class="tab-button active rounded-t-lg">城市瀏覽</button>
                    <button id="tab-sandbox" class="tab-button rounded-t-lg">氣候沙盒</button>
                    <button id="tab-quiz" class="tab-button rounded-t-lg">隨機練習</button>
                </div>
                
                <!-- Main View -->
                <div id="main-view">
                    <p class="text-gray-600 mb-4">請在地圖上點擊圖標，或從下方選單選擇城市，以查看其氣候資料。</p>
                    
                    <!-- Collapsible Rules Section -->
                    <div id="rules-container" class="bg-white border rounded-md mb-4">
                        <button id="toggle-rules-btn" class="w-full text-left p-3 font-bold flex justify-between items-center hover:bg-gray-50 rounded-t-md">
                            <span>柯本氣候分類判斷法則</span>
                            <span id="rules-arrow">▼</span>
                        </button>
                        <div id="rules-content" class="hidden p-4 border-t text-sm bg-gray-50 rounded-b-md">
                           <!-- Rules content will be populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Mobile-only Legend Container -->
                    <div id="mobile-legend-container" class="lg:hidden mb-4"></div>

                    <div class="mb-4">
                        <label for="city-selector" class="block text-sm font-medium text-gray-700 mb-1">選擇城市:</label>
                        <select id="city-selector" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <div id="city-info" class="bg-gray-50 p-4 rounded-lg">
                        <h2 id="city-name" class="text-xl font-bold text-blue-600"></h2>
                        <p id="climate-type" class="text-md font-semibold text-gray-700 mt-1"></p>
                        <p id="high-school-climate-type" class="text-sm font-medium text-indigo-600 mt-1"></p>
                        <p id="climate-description" class="text-sm text-gray-600 mt-2 h-12"></p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-4 text-center">
                        <div>
                            <p class="text-sm text-gray-500">年均溫</p>
                            <p id="annual-temp" class="text-lg font-bold text-red-600"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">年總降水量</p>
                            <p id="annual-precip" class="text-lg font-bold text-blue-600"></p>
                        </div>
                    </div>
                    <div class="mt-2">
                         <canvas id="climate-chart"></canvas>
                    </div>
                    <div id="climate-analysis" class="analysis-box"></div>
                </div>

                <!-- Sandbox View -->
                <div id="sandbox-view" class="hidden">
                     <p class="text-gray-600 mb-4">自由調整溫度與降水，探索氣候類型的變化！可載入城市範本開始。</p>
                     <div class="mb-4">
                        <label for="load-city-sandbox" class="block text-sm font-medium text-gray-700 mb-1">載入城市範本:</label>
                        <select id="load-city-sandbox" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                           <option value="">-- 自訂數據 --</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                        <div>
                            <h3 class="font-bold text-lg mb-2 text-center text-red-600">溫度 (°C)</h3>
                            <div id="temp-sliders" class="space-y-1"></div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg mb-2 text-center text-blue-600">降水量 (mm)</h3>
                            <div id="precip-sliders" class="space-y-1"></div>
                        </div>
                    </div>
                     <div class="mt-4">
                         <canvas id="sandbox-chart"></canvas>
                    </div>
                    <div id="sandbox-analysis" class="analysis-box"></div>
                </div>

                <!-- Quiz View -->
                <div id="quiz-view" class="hidden">
                    <!-- Start screen for quiz -->
                    <div id="quiz-start-screen">
                        <p class="text-gray-600 mb-4">準備好挑戰您的柯本氣候分類知識了嗎？</p>
                        <button id="start-quiz-btn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600">開始練習</button>
                    </div>

                    <!-- Question area for quiz -->
                    <div id="quiz-question-area" class="hidden">
                        <p class="text-gray-600 mb-4">請根據下方的氣候圖，判斷其所屬的柯本氣候類型。</p>
                        <div>
                            <canvas id="quiz-chart"></canvas>
                        </div>
                        <div id="quiz-options" class="mt-4"></div>
                        <div id="quiz-feedback" class="mt-4 p-3 rounded-md font-bold"></div>
                        <div id="quiz-answer-info" class="analysis-box hidden"></div>
                        <div class="mt-4 flex space-x-2">
                            <button id="submit-answer" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600">提交答案</button>
                            <button id="next-question" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-600 hidden">下一題</button>
                            <button id="end-quiz-btn" class="w-1/3 bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600">結束練習</button>
                        </div>
                    </div>
                    
                    <!-- Summary screen for quiz -->
                    <div id="quiz-summary-screen" class="hidden">
                        <h2 class="text-xl font-bold text-gray-800 mb-3">練習成果總結</h2>
                        <div id="quiz-summary-stats" class="grid grid-cols-3 gap-2 text-center mb-4 p-3 bg-blue-50 rounded-lg"></div>
                        <div id="quiz-summary-comment" class="analysis-box mb-4"></div>
                        <div id="quiz-summary-details">
                            <h3 class="font-bold mb-2">錯誤題目回顧</h3>
                            <div id="quiz-wrong-answers" class="space-y-2 text-sm"></div>
                        </div>
                        <div class="mt-6 flex space-x-2">
                             <button id="restart-quiz-btn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600">再試一次</button>
                             <button id="back-to-main-btn" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-600">返回瀏覽</button>
                        </div>
                    </div>
                </div>


                <!-- Footer with author and version -->
                <footer class="mt-8 pt-4 border-t text-center text-xs text-gray-500">
                    <p>製作：鄭伉妙，版本2.5 (2025/06)</p>
                </footer>

            </div>
        </div>
    </div>

    <script>
        // --- DATA (Curated Representative Cities) ---
        const cityData = {
            // --- TAIWAN ---
            "Taipei": { name: "臺北 (臺灣)", lat: 25.03, lon: 121.56, temps: [16.6, 17.0, 18.9, 22.3, 25.6, 28.1, 29.5, 29.2, 27.4, 24.5, 21.8, 18.2], precip: [86, 143, 169, 148, 209, 292, 226, 269, 311, 145, 87, 80] },
            "Taichung": { name: "臺中 (臺灣)", lat: 24.14, lon: 120.67, temps: [16.8, 17.6, 19.9, 23.4, 26.3, 27.9, 28.6, 28.2, 27.5, 25.2, 22.1, 18.5], precip: [27, 49, 62, 91, 211, 370, 297, 303, 169, 17, 16, 20] },
            "Kaohsiung": { name: "高雄 (臺灣)", lat: 22.62, lon: 120.30, temps: [20.2, 21.0, 23.3, 26.0, 28.1, 28.9, 29.2, 28.7, 28.2, 26.9, 24.5, 21.5], precip: [12, 18, 30, 52, 155, 395, 381, 399, 224, 43, 19, 12] },
            "Hualien": { name: "花蓮 (臺灣)", lat: 23.97, lon: 121.60, temps: [18.3, 18.8, 20.6, 23.2, 25.7, 27.7, 29.0, 28.6, 27.1, 24.9, 22.4, 19.7], precip: [59, 81, 84, 98, 184, 214, 250, 314, 350, 222, 121, 68] },
            "Yushan": { name: "玉山 (臺灣)", lat: 23.47, lon: 120.96, temps: [-0.5, 0.1, 2.1, 4.2, 6.2, 7.5, 8.2, 8.1, 7.5, 5.8, 3.5, 1.1], precip: [85, 120, 150, 260, 410, 630, 600, 550, 420, 150, 70, 65] },

            // --- A: TROPICAL ---
            "Singapore": { name: "新加坡", lat: 1.35, lon: 103.81, temps: [26.5, 26.9, 27.2, 27.5, 27.5, 27.4, 27.1, 27.0, 27.0, 27.1, 26.8, 26.5], precip: [243, 163, 193, 184, 178, 175, 169, 197, 178, 208, 252, 289] },
            "Cairns": { name: "凱恩斯 (澳)", lat: -16.92, lon: 145.77, temps: [27.6, 27.5, 26.9, 25.7, 24.0, 22.4, 21.8, 22.6, 23.9, 25.5, 26.8, 27.6], precip: [404, 452, 423, 196, 88, 48, 29, 35, 37, 48, 93, 180] }, // Am
            "Darwin": { name: "達爾文 (澳)", lat: -12.46, lon: 130.84, temps: [28.3, 28.1, 28.5, 29.3, 28.5, 26.6, 26.0, 26.9, 28.8, 29.8, 29.8, 29.1], precip: [426, 372, 316, 101, 21, 2, 1, 5, 16, 57, 141, 252] }, // Aw
            "Toamasina": { name: "圖阿馬西納 (馬達加斯加)", lat: -18.15, lon: 49.42, temps: [26.5, 26.6, 26.1, 25.2, 23.6, 22.0, 21.4, 21.6, 22.4, 23.7, 25.1, 26.2], precip: [410, 400, 451, 301, 230, 246, 276, 191, 131, 100, 131, 261] }, // Af (Madagascar East)

            // --- B: DRY ---
            "AliceSprings": { name: "愛麗斯泉 (澳)", lat: -23.70, lon: 133.88, temps: [28.8, 27.9, 25.0, 20.3, 15.6, 12.4, 12.2, 14.8, 19.3, 23.9, 26.5, 28.2], precip: [40.7, 44.3, 31.3, 16.9, 19.2, 13.5, 15.4, 9.1, 8.7, 21.7, 28.9, 37.5] }, // BWh - Data updated from BOM
            "Turpan": { name: "吐魯番 (中)", lat: 42.91, lon: 89.19, temps: [-7.6, -1.9, 8.7, 19.8, 26.5, 31.4, 33.0, 31.3, 25.0, 14.9, 3.8, -5.3], precip: [1, 1, 2, 3, 5, 8, 10, 8, 4, 2, 1, 1] }, // BWk
            "Toliara": { name: "圖利亞拉 (馬達加斯加)", lat: -23.35, lon: 43.67, temps: [27.5, 27.5, 26.7, 24.7, 22.2, 20.1, 19.8, 20.8, 22.7, 24.9, 26.3, 27.2], precip: [93, 86, 36, 11, 16, 17, 7, 5, 8, 9, 20, 97] }, // BSh (Madagascar West)
            "Mildura": { name: "米爾迪拉 (澳)", lat: -34.20, lon: 142.13, temps: [23.7, 23.2, 20.6, 16.8, 13.5, 10.8, 10.1, 11.6, 14.3, 17.3, 20.0, 22.3], precip: [23, 23, 21, 20, 25, 25, 28, 28, 28, 30, 25, 25] }, // BSk

            // --- C: TEMPERATE ---
            "Sydney": { name: "雪梨 (澳)", lat: -33.86, lon: 151.20, temps: [23.0, 23.0, 21.7, 18.9, 15.7, 13.1, 12.2, 13.3, 15.6, 18.2, 20.0, 21.9], precip: [102, 119, 129, 126, 121, 132, 97, 81, 69, 77, 84, 78] }, // Cfa
            "Melbourne": { name: "墨爾本 (澳)", lat: -37.81, lon: 144.96, temps: [20.3, 20.2, 18.5, 15.6, 12.9, 10.8, 10.1, 11.2, 12.9, 14.8, 16.8, 18.7], precip: [47, 47, 51, 57, 56, 49, 48, 50, 58, 66, 60, 59] }, // Cfb
            "Reykjavik": { name: "雷克雅維克 (冰)", lat: 64.14, lon: -21.94, temps: [-0.5, 0.4, 0.5, 2.9, 6.3, 9.0, 10.6, 10.3, 7.4, 4.4, 1.1, -0.2], precip: [76, 72, 71, 58, 44, 50, 52, 67, 86, 86, 73, 94] }, // Cfc
            "Perth": { name: "伯斯 (澳)", lat: -31.95, lon: 115.86, temps: [24.5, 24.8, 22.9, 19.4, 16.0, 13.6, 12.8, 13.3, 15.0, 17.2, 20.1, 22.7], precip: [10, 12, 19, 36, 88, 125, 145, 126, 88, 40, 22, 11] }, // Csa
            "Albany": { name: "奧爾巴尼 (澳)", lat: -35.02, lon: 117.88, temps: [20.1, 20.3, 19.3, 17.2, 14.8, 12.9, 12.1, 12.5, 13.5, 14.8, 16.8, 18.6], precip: [24, 28, 43, 69, 96, 109, 119, 102, 83, 66, 47, 33] }, // Csb
            "Kunming": { name: "昆明 (中)", lat: 25.04, lon: 102.71, temps: [9.2, 11.2, 14.6, 17.7, 19.7, 20.3, 19.8, 19.3, 17.5, 15.0, 11.6, 8.8], precip: [12, 16, 20, 25, 90, 180, 205, 200, 120, 80, 40, 12] }, // Cwb

            // --- D: CONTINENTAL ---
            "Chicago": { name: "芝加哥 (美)", lat: 41.87, lon: -87.62, temps: [-3.8, -1.8, 3.8, 9.8, 15.7, 21.2, 23.8, 22.9, 18.6, 11.7, 4.8, -2.1], precip: [52, 47, 63, 86, 96, 94, 94, 107, 82, 80, 80, 57] }, // Dfa
            "Moscow": { name: "莫斯科 (俄)", lat: 55.75, lon: 37.61, temps: [-9.3, -8.3, -2.8, 5.8, 13.1, 16.9, 18.7, 16.9, 11.2, 5.1, -1.2, -6.1], precip: [42, 36, 34, 38, 52, 75, 88, 77, 60, 60, 52, 46] }, // Dfb
            "Anchorage": { name: "安克拉治 (美)", lat: 61.21, lon: -149.90, temps: [-8.3, -6.6, -2.7, 3.3, 9.3, 13.4, 15.3, 14.1, 9.4, 2.1, -4.8, -7.2], precip: [20, 19, 16, 12, 18, 29, 46, 62, 76, 54, 30, 29] }, // Dfc
            "Beijing": { name: "北京 (中)", lat: 39.90, lon: 116.40, temps: [-3.5, -0.6, 6.0, 14.1, 20.3, 24.8, 26.5, 25.2, 20.2, 13.0, 4.3, -1.9], precip: [3, 8, 10, 25, 38, 78, 185, 160, 48, 27, 10, 3] }, // Dwa
            "Vladivostok": { name: "海參崴 (俄)", lat: 43.13, lon: 131.91, temps: [-11.9, -8.4, -1.8, 5.1, 10.5, 14.8, 19.1, 20.2, 16.0, 8.9, -0.9, -8.1], precip: [14, 19, 27, 48, 81, 110, 164, 153, 126, 59, 39, 22] }, // Dwb
            "Mohe": { name: "漠河 (中)", lat: 52.97, lon: 122.52, temps: [-28.3, -23.9, -12.9, -0.2, 8.4, 15.7, 18.2, 14.9, 7.3, -3.2, -18.4, -27.6], precip: [7, 5, 8, 23, 40, 71, 101, 91, 51, 23, 13, 8] }, // Dwc
            "Yakutsk": { name: "雅庫次克 (俄)", lat: 62.03, lon: 129.67, temps: [-38.6, -33.8, -20.1, -4.8, 7.5, 16.4, 19.5, 15.2, 5.9, -7.8, -27.3, -37.7], precip: [9, 8, 6, 9, 20, 35, 39, 37, 31, 21, 16, 10] }, // Dwd

            // --- E: POLAR ---
            "Nuuk": { name: "努克 (格陵蘭)", lat: 64.18, lon: -51.72, temps: [-8.0, -8.5, -8.1, -2.8, 2.5, 6.1, 8.5, 8.0, 4.9, 0.3, -3.1, -6.2], precip: [40, 42, 49, 49, 55, 62, 82, 89, 81, 62, 60, 48] }, // ET
            "VostokStation": { name: "東方站 (南極)", lat: -78.46, lon: 106.86, temps: [-32.1, -44.3, -57.9, -64.7, -65.6, -65.2, -66.9, -67.6, -66.0, -57.1, -43.1, -32.1], precip: [1, 1, 2, 2, 3, 2, 2, 2, 2, 2, 1, 1] } // EF
        };
        
        const koppenColorData = {
            'Af': { name: '熱帶雨林', hs_name: '熱帶雨林氣候', color: '#669966', description: '終年高溫多雨，無明顯乾季。'},
            'Am': { name: '熱帶季風', hs_name: '熱帶季風氣候', color: '#7DB47D', description: '終年高溫，有短暫乾季。'},
            'Aw': { name: '熱帶莽原', hs_name: '熱帶莽原氣候', color: '#99CC99', description: '終年高溫，乾濕季分明。'},
            'BWh':{ name: '熱帶沙漠', hs_name: '熱帶乾燥氣候', color: '#FFCC66', description: '終年炎熱乾燥，降水稀少。'},
            'BWk':{ name: '溫帶沙漠', hs_name: '溫帶乾燥氣候', color: '#FFE066', description: '冬冷夏熱，全年乾燥。'},
            'BSh':{ name: '熱帶草原', hs_name: '熱帶乾燥氣候', color: '#FFDB4D', description: '終年高溫，降水較沙漠略多。'},
            'BSk':{ name: '溫帶草原', hs_name: '溫帶乾燥氣候', color: '#FFFACD', description: '冬冷夏熱，半乾燥氣候。'},
            'Csa':{ name: '地中海夏熱', hs_name: '溫帶地中海型氣候', color: '#CCCC66', description: '夏熱乾，冬溫雨。'},
            'Csb':{ name: '地中海夏涼', hs_name: '溫帶地中海型氣候', color: '#D9D977', description: '夏涼乾，冬溫雨。'},
            'Cwa':{ name: '溫帶冬乾夏熱', hs_name: '溫帶季風氣候', color: '#99CC00', description: '夏熱多雨，冬溫少雨。'},
            'Cwb':{ name: '溫帶冬乾夏涼', hs_name: '溫帶季風氣候', color: '#AAFF00', description: '夏涼多雨，冬溫少雨。'},
            'Cfa':{ name: '溫帶濕潤夏熱', hs_name: '溫帶季風氣候', color: '#999966', description: '夏熱多雨，冬溫濕潤。'},
            'Cfb':{ name: '溫帶海洋性', hs_name: '溫帶海洋性氣候', color: '#B3B38C', description: '冬溫夏涼，全年有雨。'},
            'Cfc':{ name: '副極地海洋性', hs_name: '溫帶海洋性氣候', color: '#CCCCA3', description: '無明顯夏季，冬溫濕潤。'},
            'Dfa':{ name: '濕潤大陸夏熱', hs_name: '溫帶大陸性氣候', color: '#9999CC', description: '夏熱冬寒，四季分明。'},
            'Dfb':{ name: '濕潤大陸夏涼', hs_name: '溫帶大陸性氣候', color: '#A8A8D6', description: '夏涼冬寒，四季分明。'},
            'Dfc':{ name: '亞寒帶', hs_name: '寒帶氣候', color: '#B8B8E0', description: '夏短涼，冬長嚴寒。'},
            'Dfd':{ name: '亞寒帶(嚴冬)', hs_name: '寒帶氣候', color: '#C8C8EA', description: '夏短涼，冬極嚴寒。'},
            'Dwa':{ name: '季風大陸夏熱', hs_name: '溫帶大陸性氣候', color: '#B399CC', description: '夏熱多雨，冬寒乾燥。'},
            'Dwb':{ name: '季風大陸夏涼', hs_name: '溫帶大陸性氣候', color: '#C2A8D6', description: '夏涼多雨，冬寒乾燥。'},
            'Dwc':{ name: '季風亞寒帶', hs_name: '寒帶氣候', color: '#D1B8E0', description: '夏短涼雨，冬長嚴寒乾燥。'},
            'Dwd':{ name: '季風亞寒帶(嚴冬)', hs_name: '寒帶氣候', color: '#E0C8EA', description: '夏短涼雨，冬極嚴寒乾燥。'},
            'ET': { name: '苔原氣候', hs_name: '極地苔原氣候', color: '#CCCCCC', description: '終年嚴寒，夏短暫且涼。'},
            'EF': { name: '冰原氣候', hs_name: '極地冰原氣候', color: '#F0F0F0', description: '終年酷寒，長年冰封。'}
        };

        // --- MAP INITIALIZATION ---
        const map = L.map('map', { zoomControl: true }).setView([23.973875, 120.982025], 5); // Center on Taiwan
        map.zoomControl.setPosition('topleft');
        
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        }).addTo(map);

        // --- CHART & UI VARIABLES ---
        const mainCtx = document.getElementById('climate-chart').getContext('2d');
        const sandboxCtx = document.getElementById('sandbox-chart').getContext('2d');
        const quizCtx = document.getElementById('quiz-chart').getContext('2d');
        let mainClimateChart, sandboxClimateChart, quizClimateChart, quizAnswerMarker;
        let currentQuizKey = null;
        let quizHistory = [];

        // --- KÖPPEN CLASSIFICATION LOGIC ---
        function calculateKoppenType(temps, precip, lat = 30) {
            const avgTemp = temps.reduce((a, b) => a + b, 0) / 12;
            const totalPrecip = precip.reduce((a, b) => a + b, 0);
            const minTemp = Math.min(...temps);
            const maxTemp = Math.max(...temps);
            const monthsOver10 = temps.filter(t => t > 10).length;

            const summerMonths = (lat >= 0) ? [3, 4, 5, 6, 7, 8] : [9, 10, 11, 0, 1, 2];
            const winterMonths = (lat >= 0) ? [9, 10, 11, 0, 1, 2] : [3, 4, 5, 6, 7, 8];
            
            const precipSummer = summerMonths.reduce((sum, i) => sum + (precip[i] || 0), 0);
            const precipWinter = winterMonths.reduce((sum, i) => sum + (precip[i] || 0), 0);
            
            const precipWettestMonth = Math.max(...precip);
            const precipDriestMonth = Math.min(...precip);

            const precipWettestMonthSummer = Math.max(...summerMonths.map(i => precip[i] || 0));
            const precipDriestMonthSummer = Math.min(...summerMonths.map(i => precip[i] || 0));
            const precipWettestMonthWinter = Math.max(...winterMonths.map(i => precip[i] || 0));
            const precipDriestMonthWinter = Math.min(...winterMonths.map(i => precip[i] || 0));

            // Step 1: Check for E climates
            if (maxTemp <= 10) {
                return maxTemp <= 0 ? 'EF' : 'ET';
            }

            // Step 2: Check for B climates
            let pThreshold;
            if (totalPrecip === 0) pThreshold = 20 * avgTemp + 140; // handle divide by zero
            else if (precipSummer / totalPrecip >= 0.7) {
                pThreshold = 20 * avgTemp + 280; // Summer concentration
            } else if (precipWinter / totalPrecip >= 0.7) {
                pThreshold = 20 * avgTemp; // Winter concentration
            } else {
                pThreshold = 20 * avgTemp + 140; // Even distribution
            }

            if (totalPrecip < pThreshold) {
                const thirdLetter = avgTemp >= 18 ? 'h' : 'k';
                if (totalPrecip < pThreshold / 2) {
                    return 'BW' + thirdLetter;
                } else {
                    return 'BS' + thirdLetter;
                }
            }

            // Step 3: Check for A, C, D climates
            let firstLetter = '';
            if (minTemp >= 18) firstLetter = 'A';
            else if (minTemp <= -3) firstLetter = 'D';
            else firstLetter = 'C';

            let secondLetter = '';
            if (firstLetter === 'A') {
                if (precipDriestMonth >= 60) {
                    secondLetter = 'f';
                } else if (totalPrecip > 25 * (100 - precipDriestMonth)) { 
                    secondLetter = 'm';
                } else {
                    secondLetter = 'w';
                }
                return 'A' + secondLetter;
            }

            // For C and D climates
            // LOGIC FIX: Prioritize 'w' check over 's' check to correctly classify monsoon-influenced climates.
            const isWinterDry = precipWettestMonthSummer >= 10 * precipDriestMonthWinter;
            const isSummerDry = precipWettestMonthWinter >= 3 * precipDriestMonthSummer && precipDriestMonthSummer < 40;
            
            if (isWinterDry) {
                secondLetter = 'w';
            } else if (isSummerDry) {
                secondLetter = 's';
            } else {
                secondLetter = 'f';
            }

            let thirdLetter = '';
            if (firstLetter === 'C') {
                if (maxTemp >= 22) thirdLetter = 'a';
                else if (monthsOver10 >= 4) thirdLetter = 'b';
                else thirdLetter = 'c';
            } else if (firstLetter === 'D') {
                 if (minTemp < -38) thirdLetter = 'd';
                 else if (maxTemp >= 22) thirdLetter = 'a';
                 else if (monthsOver10 >= 4) thirdLetter = 'b';
                 else thirdLetter = 'c';
            }
            
            return firstLetter + secondLetter + thirdLetter;
        }


        // --- CHART RENDERING FUNCTION ---
        function createOrUpdateClimateChart(ctx, chartData, chartInstance) {
            const months = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];
            if (chartInstance) { chartInstance.destroy(); }
            const koppenType = chartData.type || calculateKoppenType(chartData.temps, chartData.precip, chartData.lat);
            const typeInfo = koppenColorData[koppenType] || { name: '未知類型' };
            
            const chartTitle = chartData.name ? `${chartData.name} 氣候圖` : `模擬氣候圖 (${koppenType} - ${typeInfo.name})`;
            
            return new Chart(ctx, {
                type: 'bar', data: { labels: months, datasets: [
                        { type: 'line', label: '溫度 (°C)', data: chartData.temps, borderColor: '#ef4444', backgroundColor: '#ef4444', yAxisID: 'yTemp', tension: 0.3, borderWidth: 2.5, pointBackgroundColor: '#ef4444' },
                        { type: 'bar', label: '降水量 (mm)', data: chartData.precip, backgroundColor: '#3b82f6', borderColor: '#3b82f6', yAxisID: 'yPrecip', }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: true, plugins: { title: { display: true, text: chartTitle, font: { size: 16, family: "'Noto Sans TC', sans-serif" } }, legend: { display: true, position: 'bottom' } },
                    scales: { x: { title: { display: true, text: '月份', font: { size: 12, family: "'Noto Sans TC', sans-serif" } } },
                        yTemp: { type: 'linear', position: 'left', title: { display: true, text: '氣溫 (°C)', font: { size: 12, family: "'Noto Sans TC', sans-serif" } }, grid: { drawOnChartArea: false } },
                        yPrecip: { type: 'linear', position: 'right', title: { display: true, text: '降水量 (mm)', font: { size: 12, family: "'Noto Sans TC', sans-serif" } }, }
                    }
                }
            });
        }
        
        function getHighSchoolClassification(cityKey, koppenCode) {
            // Special rules for Taiwan cities to align with local curriculum
            if (cityKey && cityData[cityKey] && cityData[cityKey].name.includes('臺灣')) {
                if (cityKey === 'Yushan') {
                    return '高地氣候';
                }
                if (koppenCode.startsWith('A')) {
                    return '熱帶季風氣候';
                }
                if (koppenCode.startsWith('C')) {
                    return '副熱帶季風氣候';
                }
            }
            
            // Default classification for all other locations
            const typeInfo = koppenColorData[koppenCode];
            return typeInfo ? typeInfo.hs_name : '未知類型';
        }


        // --- UI UPDATE FUNCTION ---
        function updateInfoPanel(cityKey) {
            const city = JSON.parse(JSON.stringify(cityData[cityKey])); // Deep copy
            city.type = calculateKoppenType(city.temps, city.precip, city.lat); // Recalculate for accuracy
            const climateDetail = koppenColorData[city.type] || { name: '未知類型', description: '無詳細資料。' };
            const hsClimateName = getHighSchoolClassification(cityKey, city.type);

            document.getElementById('city-name').textContent = city.name;
            document.getElementById('climate-type').textContent = `${climateDetail.name} (${city.type})`;
            document.getElementById('high-school-climate-type').textContent = `高中分類：${hsClimateName}`;
            document.getElementById('climate-description').textContent = climateDetail.description;

            const totalPrecip = city.precip.reduce((a, b) => a + b, 0);
            const avgTemp = city.temps.reduce((a, b) => a + b, 0) / city.temps.length;
            document.getElementById('annual-precip').textContent = `${totalPrecip.toFixed(0)} mm`;
            document.getElementById('annual-temp').textContent = `${avgTemp.toFixed(1)} °C`;
            mainClimateChart = createOrUpdateClimateChart(mainCtx, city, mainClimateChart);
            document.getElementById('city-selector').value = cityKey;
            generateAnalysis(cityKey, document.getElementById('climate-analysis'));
        }

        // --- CLIMATE ANALYSIS LOGIC ---
        function generateAnalysis(cityObjectOrKey, container) {
            let city, cityKey;
            
            if (typeof cityObjectOrKey === 'string') {
                cityKey = cityObjectOrKey;
                city = cityData[cityKey];
            } else {
                cityKey = null; // It's an object (from sandbox), no key.
                city = cityObjectOrKey;
            }
            
            if (!city || !city.temps || !city.precip) {
                 console.error("Invalid data for analysis", cityObjectOrKey);
                 container.innerHTML = '<h5>分析錯誤</h5><p>無法生成分析報告，資料不完整。</p>';
                 return;
            }
            
            const { temps, precip, lat } = city;
            const type = calculateKoppenType(temps, precip, lat || 0); // Use default lat 0 for sandbox
            const hsClimateName = getHighSchoolClassification(cityKey, type);
            const minTemp = Math.min(...temps);
            const maxTemp = Math.max(...temps);
            const totalPrecip = precip.reduce((a,b) => a + b, 0);
            let analysisHtml = `<h5>判讀依據分析</h5>`;
            
            const firstLetter = type.charAt(0);
            let tempAnalysis = '', precipAnalysis = '', thirdLetterAnalysis = '';

            // 1. First letter
            if (firstLetter === 'E') tempAnalysis = `最暖月均溫 ${maxTemp.toFixed(1)}°C ≤ 10°C，屬極地氣候(E)。`;
            else if (firstLetter === 'B') tempAnalysis = `年總降水量 ${totalPrecip.toFixed(0)}mm 低於乾燥閾值，屬乾燥氣候(B)。`;
            else if (firstLetter === 'A') tempAnalysis = `最冷月均溫 ${minTemp.toFixed(1)}°C ≥ 18°C，屬熱帶氣候(A)。`;
            else if (firstLetter === 'D') tempAnalysis = `最冷月均溫 ${minTemp.toFixed(1)}°C ≤ -3°C，屬寒帶氣候(D)。`;
            else if (firstLetter === 'C') tempAnalysis = `最冷月均溫 ${minTemp.toFixed(1)}°C 介於 -3°C ~ 18°C 之間，屬溫帶氣候(C)。`;
            
            // 2. Second letter
            const secondLetter = type.length > 1 ? type[1] : '';
            if (['A', 'C', 'D'].includes(firstLetter)) {
                if (secondLetter === 'f') precipAnalysis = `降水季節分布相對均勻，無明顯乾季(f)。`;
                else if (secondLetter === 's') precipAnalysis = `夏季(${lat > 0 ? '6-8月':'12-2月'})乾燥，冬季多雨，呈現夏乾冬雨(s)型態。`;
                else if (secondLetter === 'w') precipAnalysis = `冬季(${lat > 0 ? '12-2月':'6-8月'})乾燥，夏季多雨，呈現冬乾夏雨(w)型態。`;
                else if (secondLetter === 'm') precipAnalysis = `降水型態介於雨林與莽原之間，屬熱帶季風(m)型。`;
            } else {
                 precipAnalysis = `年總降水量 ${totalPrecip.toFixed(0)}mm。`
            }
            
            // 3. Third letter
            const thirdLetter = type.length > 2 ? type[2] : '';
            if (thirdLetter) {
                if (thirdLetter === 'a') thirdLetterAnalysis = `最暖月均溫 ${maxTemp.toFixed(1)}°C ≥ 22°C，為炎夏(a)。`;
                else if (thirdLetter === 'b') thirdLetterAnalysis = `最暖月均溫 ${maxTemp.toFixed(1)}°C < 22°C 且暖於10°C月份≥4個，為暖夏(b)。`;
                else if (thirdLetter === 'c') thirdLetterAnalysis = `暖於10°C月份<4個，為涼夏(c)。`;
                else if (thirdLetter === 'd') thirdLetterAnalysis = `最冷月均溫 ${minTemp.toFixed(1)}°C < -38°C，為嚴冬(d)。`;
                else if (thirdLetter === 'h') thirdLetterAnalysis = `年均溫 ≥ 18°C，為熱(h)。`;
                else if (thirdLetter === 'k') thirdLetterAnalysis = `年均溫 < 18°C，為冷(k)。`;
            }

            analysisHtml += `<p><b>1. 氣溫主帶：</b>${tempAnalysis}</p>`;
            analysisHtml += `<p><b>2. 降水季節：</b>${precipAnalysis}</p>`;
            if (thirdLetterAnalysis) analysisHtml += `<p><b>3. 氣溫程度：</b>${thirdLetterAnalysis}</p>`;
            analysisHtml += `<p><b>最終結論：</b>綜合判斷為 <b>${type} (${(koppenColorData[type] || {}).name || '未知'})</b>，在高中課程中通稱為<b>${hsClimateName}</b>。</p>`;
            container.innerHTML = analysisHtml;
        }

        // --- POPULATE SELECTORS ---
        const citySelector = document.getElementById('city-selector');
        const sandboxCitySelector = document.getElementById('load-city-sandbox');
        const allCityKeys = Object.keys(cityData);
        // Sort city keys, Taiwan cities first, then alphabetically
        allCityKeys.sort((a, b) => {
            const aIsTaiwan = cityData[a].name.includes('臺灣');
            const bIsTaiwan = cityData[b].name.includes('臺灣');
            if (aIsTaiwan && !bIsTaiwan) return -1;
            if (!aIsTaiwan && bIsTaiwan) return 1;
            return cityData[a].name.localeCompare(cityData[b].name, 'zh-Hant');
        });

        allCityKeys.forEach(key => {
            const city = cityData[key];
            // Recalculate type based on our function to ensure consistency
            const calculatedType = calculateKoppenType(city.temps, city.precip, city.lat);
            cityData[key].type = calculatedType; // Update the master data object

            const markerColor = koppenColorData[calculatedType] ? koppenColorData[calculatedType].color : '#808080';
            const customIcon = L.divIcon({ className: 'custom-div-icon', html: `<div style="background-color:${markerColor};" class="w-5 h-5 rounded-full border-2 border-white shadow-xl"></div>`, iconSize: [20, 20], iconAnchor: [10, 10] });
            const marker = L.marker([city.lat, city.lon], { icon: customIcon }).addTo(map);
            marker.bindTooltip(city.name, { permanent: false, direction: 'top', offset: [0, -10], className: 'city-label-tooltip' });
            marker.on('click', () => { 
                if (document.getElementById('main-view').style.display !== 'none') { 
                    map.setView([city.lat, city.lon], 7); updateInfoPanel(key); 
                }
            });
            const option = document.createElement('option');
            option.value = key; option.textContent = `${city.name} (${calculatedType})`;
            citySelector.appendChild(option);
            sandboxCitySelector.appendChild(option.cloneNode(true));
        });
        
        citySelector.addEventListener('change', (event) => { const cityKey = event.target.value; const city = cityData[cityKey]; map.setView([city.lat, city.lon], 7); updateInfoPanel(cityKey); });
        
        // --- ADDING KÖPPEN CLIMATE GEOJSON LAYER ---
        const climateJsonUrl = 'https://gist.githubusercontent.com/gemini-generative-ai/e4bf815ab9c342d4a572242c73d9319e/raw/33a18a803f26a111244e883e449a04f2d3fcb00f/koppen_climate.geojson';
        fetch(climateJsonUrl).then(res => res.json()).then(data => {
            L.geoJson(data, { style: feature => { const gridcode = feature.properties.GRIDCODE; const climateType = Object.values(koppenColorData).find(d => d.gridcode === gridcode); const fillColor = climateType ? climateType.color : 'transparent'; return { fillColor, fillOpacity: 0.65, weight: 0 }; }, interactive: false }).addTo(map);
            Object.values(map._layers).forEach(layer => { if (layer instanceof L.Marker) { layer.bringToFront(); } });
        });

        // --- ADDING LATITUDE LINES ---
        const latLines = [
            { lat: 60, label: '北緯 60°' }, { lat: 40, label: '北緯 40°' },
            { lat: 23.5, label: '北回歸線 23.5°' }, { lat: 0, label: '赤道 0°' },
            { lat: -23.5, label: '南回歸線 23.5°' }, { lat: -40, label: '南緯 40°' },
            { lat: -60, label: '南緯 60°' }
        ];
        const lineStyle = { color: 'rgba(255, 255, 255, 0.7)', weight: 1.5, dashArray: '5, 10' };
        latLines.forEach(line => {
            L.polyline([[line.lat, -180], [line.lat, 180]], lineStyle).addTo(map);
            L.marker([line.lat, -150], { icon: L.divIcon({ className: 'lat-label', html: `<span>${line.label}</span>` }) }).addTo(map);
        });

        // --- LEGEND LOGIC ---
        let legendControl;
        // ... (rest of legend logic is unchanged but will be called)

        // --- TAB SWITCHING LOGIC ---
        const tabs = {
            main: document.getElementById('tab-main'),
            sandbox: document.getElementById('tab-sandbox'),
            quiz: document.getElementById('tab-quiz'),
        };
        const views = {
            main: document.getElementById('main-view'),
            sandbox: document.getElementById('sandbox-view'),
            quiz: document.getElementById('quiz-view'),
        }

        Object.keys(tabs).forEach(key => {
            tabs[key].addEventListener('click', () => {
                Object.values(tabs).forEach(t => t.classList.remove('active'));
                tabs[key].classList.add('active');
                
                Object.values(views).forEach(v => v.style.display = 'none');
                views[key].style.display = 'block';

                // Reset quiz to start screen when tab is clicked
                if(key === 'quiz') {
                    document.getElementById('quiz-start-screen').style.display = 'block';
                    document.getElementById('quiz-question-area').style.display = 'none';
                    document.getElementById('quiz-summary-screen').style.display = 'none';
                }
            });
        });

        // --- SANDBOX LOGIC ---
        const tempSlidersContainer = document.getElementById('temp-sliders');
        const precipSlidersContainer = document.getElementById('precip-sliders');

        function initSandbox() {
            for (let i = 1; i <= 12; i++) {
                // Temperature Slider
                tempSlidersContainer.innerHTML += `
                    <div class="slider-container text-sm">
                        <label for="temp${i}">${i}月</label>
                        <input type="range" id="temp${i}" min="-40" max="40" value="10" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span id="temp-val${i}" class="font-mono text-right">10°C</span>
                    </div>`;
                // Precipitation Slider
                precipSlidersContainer.innerHTML += `
                    <div class="slider-container text-sm">
                        <label for="precip${i}">${i}月</label>
                        <input type="range" id="precip${i}" min="0" max="600" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span id="precip-val${i}" class="font-mono text-right">50mm</span>
                    </div>`;
            }

            for (let i = 1; i <= 12; i++) {
                document.getElementById(`temp${i}`).addEventListener('input', updateSandbox);
                document.getElementById(`precip${i}`).addEventListener('input', updateSandbox);
            }
            updateSandbox();
        }

        function updateSandbox() {
            let temps = [], precip = [];
            for (let i = 1; i <= 12; i++) {
                const tempVal = parseFloat(document.getElementById(`temp${i}`).value);
                const precipVal = parseFloat(document.getElementById(`precip${i}`).value);
                temps.push(tempVal);
                precip.push(precipVal);
                document.getElementById(`temp-val${i}`).textContent = `${tempVal.toFixed(0)}°C`;
                document.getElementById(`precip-val${i}`).textContent = `${precipVal.toFixed(0)}mm`;
            }
            
            const sandboxData = { temps, precip, name: '自訂' };
            sandboxClimateChart = createOrUpdateClimateChart(sandboxCtx, sandboxData, sandboxClimateChart);
            generateAnalysis(sandboxData, document.getElementById('sandbox-analysis'));
        }

        sandboxCitySelector.addEventListener('change', (e) => {
            const cityKey = e.target.value;
            if (!cityKey) return;
            const city = cityData[cityKey];
            for (let i = 0; i < 12; i++) {
                document.getElementById(`temp${i+1}`).value = city.temps[i];
                document.getElementById(`precip${i+1}`).value = city.precip[i];
            }
            updateSandbox();
        });


        // --- QUIZ LOGIC ---
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const restartQuizBtn = document.getElementById('restart-quiz-btn');
        const submitBtn = document.getElementById('submit-answer');
        const nextBtn = document.getElementById('next-question');
        const endQuizBtn = document.getElementById('end-quiz-btn');
        const backToMainBtn = document.getElementById('back-to-main-btn');
        
        startQuizBtn.addEventListener('click', startQuiz);
        restartQuizBtn.addEventListener('click', startQuiz);
        endQuizBtn.addEventListener('click', showQuizSummary);

        backToMainBtn.addEventListener('click', () => {
            document.getElementById('tab-main').click();
        });
        
        function startQuiz() {
            quizHistory = [];
            document.getElementById('quiz-start-screen').style.display = 'none';
            document.getElementById('quiz-summary-screen').style.display = 'none';
            document.getElementById('quiz-question-area').style.display = 'block';
            loadNewQuestion();
        }

        function loadNewQuestion() {
            if (quizAnswerMarker) { map.removeLayer(quizAnswerMarker); quizAnswerMarker = null; }
            currentQuizKey = allCityKeys[Math.floor(Math.random() * allCityKeys.length)];
            const city = cityData[currentQuizKey];
            quizClimateChart = createOrUpdateClimateChart(quizCtx, { ...city, name: '匿名測驗城市' }, quizClimateChart);
            const correctAnswer = city.type;
            const options = new Set([correctAnswer]);
            const allTypes = Object.keys(koppenColorData);
            while(options.size < 4) { const randomType = allTypes[Math.floor(Math.random() * allTypes.length)]; options.add(randomType); }
            const shuffledOptions = Array.from(options).sort(() => Math.random() - 0.5);
            const optionsContainer = document.getElementById('quiz-options');
            optionsContainer.innerHTML = '';
            shuffledOptions.forEach(opt => {
                const hsName = getHighSchoolClassification(null, opt);
                optionsContainer.innerHTML += `<label class="quiz-option"><input type="radio" name="quiz" value="${opt}" class="sr-only"> ${opt}: ${koppenColorData[opt].name} (${hsName})</label>`;
            });
            document.querySelectorAll('.quiz-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });
            submitBtn.disabled = false;
            submitBtn.style.display = 'inline-block';
            endQuizBtn.style.display = 'inline-block';
            nextBtn.style.display = 'none';
            document.getElementById('quiz-feedback').innerHTML = '';
            document.getElementById('quiz-answer-info').style.display = 'none';
        }

        submitBtn.addEventListener('click', () => {
            const selected = document.querySelector('input[name="quiz"]:checked');
            if (!selected) { alert('請選擇一個答案！'); return; }

            const feedbackEl = document.getElementById('quiz-feedback');
            const answerInfoEl = document.getElementById('quiz-answer-info');
            const city = cityData[currentQuizKey];
            const correctAnswer = city.type;
            const userAnswer = selected.value;
            const isCorrect = userAnswer === correctAnswer;
            
            quizHistory.push({
                questionKey: currentQuizKey,
                userAnswer: userAnswer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect
            });
            
            if (isCorrect) {
                feedbackEl.innerHTML = '答對了！';
                feedbackEl.className = 'text-green-600 bg-green-100 p-3 rounded-md font-bold';
            } else {
                feedbackEl.innerHTML = `答錯了，正確答案是 <b>${correctAnswer}: ${koppenColorData[correctAnswer].name}</b>`;
                feedbackEl.className = 'text-red-600 bg-red-100 p-3 rounded-md font-bold';
            }
            
            map.flyTo([city.lat, city.lon], 8); 
            if (quizAnswerMarker) { map.removeLayer(quizAnswerMarker); }
            quizAnswerMarker = L.circleMarker([city.lat, city.lon], { radius: 15, fillColor: koppenColorData[correctAnswer].color, color: "#fff", weight: 3, opacity: 1, fillOpacity: 0.8 }).addTo(map);

            answerInfoEl.innerHTML = `<h5>正確答案：${city.name}</h5>`;
            generateAnalysis(currentQuizKey, answerInfoEl);
            answerInfoEl.style.display = 'block';
            submitBtn.style.display = 'none';
            nextBtn.style.display = 'inline-block';
        });
        nextBtn.addEventListener('click', loadNewQuestion);

        function showQuizSummary() {
            document.getElementById('quiz-question-area').style.display = 'none';
            document.getElementById('quiz-summary-screen').style.display = 'block';

            const total = quizHistory.length;
            if (total === 0) {
                 document.getElementById('quiz-summary-stats').innerHTML = `
                    <div><p class="text-sm text-gray-500">答對題數</p><p class="text-lg font-bold text-green-600">0</p></div>
                    <div><p class="text-sm text-gray-500">總題數</p><p class="text-lg font-bold text-gray-700">0</p></div>
                    <div><p class="text-sm text-gray-500">正確率</p><p class="text-lg font-bold text-blue-600">--</p></div>
                 `;
                 document.getElementById('quiz-summary-comment').innerHTML = '<h5>總結評語</h5><p>您尚未開始答題，快點擊「再試一次」開始挑戰吧！</p>';
                 document.getElementById('quiz-wrong-answers').parentElement.style.display = 'none';
                return;
            }

            const correct = quizHistory.filter(q => q.isCorrect).length;
            const accuracy = (correct / total) * 100;

            document.getElementById('quiz-summary-stats').innerHTML = `
                <div><p class="text-sm text-gray-500">答對題數</p><p class="text-lg font-bold text-green-600">${correct}</p></div>
                <div><p class="text-sm text-gray-500">總題數</p><p class="text-lg font-bold text-gray-700">${total}</p></div>
                <div><p class="text-sm text-gray-500">正確率</p><p class="text-lg font-bold text-blue-600">${accuracy.toFixed(0)}%</p></div>
            `;

            let comment = '';
            if (accuracy >= 90) {
                comment = '<h5>總結評語</h5><p>太棒了！您對柯本氣候分類的掌握非常純熟，幾乎是專家等級了！</p>';
            } else if (accuracy >= 70) {
                comment = '<h5>總結評語</h5><p>表現得很好！您對大部分氣候類型都有不錯的理解，可以針對答錯的類型多加練習。</p>';
            } else if (accuracy >= 50) {
                comment = '<h5>總結評語</h5><p>還不錯，已經有基本的概念了。多加練習可以幫助您更熟悉不同氣候的判斷細節。</p>';
            } else {
                comment = '<h5>總結評語</h5><p>別氣餒！柯本氣候分類有些複雜。建議您回到瀏覽模式多看看範例，或複習判斷法則，很快就能上手！</p>';
            }
            document.getElementById('quiz-summary-comment').innerHTML = comment;

            const wrongAnswers = quizHistory.filter(q => !q.isCorrect);
            const wrongAnswersContainer = document.getElementById('quiz-wrong-answers');
            if (wrongAnswers.length > 0) {
                wrongAnswersContainer.parentElement.style.display = 'block';
                wrongAnswersContainer.innerHTML = wrongAnswers.map(q => `
                    <div class="p-2 border rounded-md bg-white">
                        <p class="font-semibold">${cityData[q.questionKey].name}</p>
                        <p>您的答案: <span class="font-bold text-red-600">${q.userAnswer}</span> (${getHighSchoolClassification(null, q.userAnswer)})</p>
                        <p>正確答案: <span class="font-bold text-green-600">${q.correctAnswer}</span> (${getHighSchoolClassification(q.questionKey, q.correctAnswer)})</p>
                    </div>
                `).join('');
            } else {
                 wrongAnswersContainer.parentElement.style.display = 'block';
                 wrongAnswersContainer.innerHTML = `<p class="text-center text-gray-500 p-4 bg-green-50 rounded-md">恭喜您全部答對！</p>`;
            }
        }

        // --- INITIAL LOAD & MISC ---
        function setRulesContent() {
             const container = document.getElementById('rules-content');
             container.innerHTML = `
                <h4 class="font-bold text-base mb-2">第一步：判斷特殊氣候</h4>
                <ul class="list-disc list-inside space-y-1">
                    <li><b>E (極地)</b>：最暖月均溫 ≤ 10°C</li>
                    <li id="dry-climate-rule">
                        <b>B (乾燥)</b>：年降水量 < 乾燥指數
                        <button id="dryness-help-btn" class="ml-2 text-xs bg-indigo-100 text-indigo-700 font-bold rounded-full w-4 h-4 text-center cursor-pointer hover:bg-indigo-200">?</button>
                    </li>
                </ul>
                <div id="dryness-explanation" class="hidden explanation-box space-y-2">
                    <p class="font-bold">🤔 如何判斷乾燥氣候？(水桶挑戰！)</p>
                    <p>想像氣候是個水桶，<b>降雨(P)</b>是倒進去的水💧，而<b>蒸發</b>會讓水漏光。</p>
                    <p>如果「年總降水量」<b class="text-red-600">少於</b>「年總蒸發量」，氣候就是乾燥的！</p>
                    <p>蒸發量(乾燥門檻)由兩件事決定：</p>
                    <ul class="list-decimal list-inside ml-2 space-y-1">
                        <li><b>基本蒸發 (看溫度🌡️)</b>：年均溫(T)越高，蒸發越快。這是公式中的 <b>20T</b>。</li>
                        <li><b>季節加成 (看雨季☀️/❄️)</b>：
                            <ul class="list-disc list-inside ml-4">
                                <li><b>夏雨型</b>: 雨下在熱天，蒸發超快，所以門檻超高 (公式+280)。</li>
                                <li><b>冬雨型</b>: 雨下在冷天，蒸發很慢，所以門檻最低 (公式+0)。</li>
                                <li><b>均勻型</b>: 介於中間 (公式+140)。</li>
                            </ul>
                        </li>
                    </ul>
                    <p class="font-semibold">結論：只要實際降雨 P < 乾燥門檻 (20T+X)，就是B型乾燥氣候！</p>
                </div>

                <h4 class="font-bold text-base mt-4 mb-2">第二步：判斷濕潤氣候主群 (A,C,D)</h4>
                <ul class="list-disc list-inside space-y-1">
                    <li><b>A (熱帶)</b>：最冷月均溫 ≥ 18°C</li>
                    <li><b>D (寒帶)</b>：最冷月均溫 ≤ -3°C</li>
                    <li><b>C (溫帶)</b>：介於兩者之間</li>
                </ul>

                <h4 class="font-bold text-base mt-4 mb-2">第三步：用「降水季節」決定第二個字母 (f, w, s, m)</h4>
                <p>這一步是看雨水什麼時候下，決定氣候的「脾氣」。(僅適用於A, C, D型)</p>
                <ul class="list-disc list-inside space-y-1">
                    <li><b>f (feucht/fully humid)</b>：全年濕潤💧，最乾月的降水量也達標，沒有明顯乾季。</li>
                    <li><b>w (winter dry)</b>：冬乾夏雨☀️，冬季有明顯乾季，雨水集中在夏季。</li>
                    <li><b>s (summer dry)</b>：夏乾冬雨❄️，夏季有明顯乾季，雨水集中在冬季 (如地中海型氣候)。</li>
                    <li><b>m (monsoonal)</b>：熱帶季風🌴，介於雨林(Af)和莽原(Aw)之間的過渡型態。</li>
                </ul>

                <h4 class="font-bold text-base mt-4 mb-2">第四步：用「溫度程度」決定第三個字母 (a, b, c, d, h, k)</h4>
                <p>這一步是為氣候加上「溫度形容詞」，讓分類更精確。</p>
                <ul class="list-disc list-inside space-y-1">
                    <li><b>適用於 C/D 型氣候：</b></li>
                    <ul class="list-disc list-inside ml-4">
                        <li><b>a (hot summer)</b>：炎夏型🌡️，最熱月均溫 ≥ 22°C。</li>
                        <li><b>b (warm summer)</b>：暖夏型😌，最熱月均溫 < 22°C，但至少有4個月均溫 ≥ 10°C。</li>
                        <li><b>c (cool summer)</b>：涼夏型🥶，均溫 ≥ 10°C 的月份只有1-3個月。</li>
                        <li><b>d (very cold winter)</b>：嚴冬型🧊，最冷月均溫 < -38°C (僅D型)。</li>
                    </ul>
                    <li><b>適用於 B 型氣候：</b></li>
                    <ul class="list-disc list-inside ml-4">
                        <li><b>h (heiß/hot)</b>：熱型🔥，年均溫 ≥ 18°C。</li>
                        <li><b>k (kalt/cold)</b>：冷型❄️，年均溫 < 18°C。</li>
                    </ul>
                </ul>
                `;
            
            document.getElementById('dryness-help-btn').addEventListener('click', (e) => {
                e.stopPropagation(); // Prevents the main accordion from closing
                document.getElementById('dryness-explanation').classList.toggle('hidden');
            });
        }
        setRulesContent();
        document.getElementById('toggle-rules-btn').addEventListener('click', () => {
            const content = document.getElementById('rules-content');
            content.classList.toggle('hidden');
            document.getElementById('rules-arrow').textContent = content.classList.contains('hidden') ? '▼' : '▲';
        });

        // --- Legend setup (unchanged) ---
        function setupLegend() {
            const legendContainer = document.getElementById('mobile-legend-container');
            const legendContent = getLegendHTML();

            if (window.innerWidth < 1024) { // Mobile
                if (legendControl) { map.removeControl(legendControl); legendControl = null; }
                legendContainer.innerHTML = `<div class="legend">${legendContent}</div>`;
            } else { // Desktop
                legendContainer.innerHTML = '';
                if (!legendControl) {
                    legendControl = L.control({position: 'bottomright'});
                    legendControl.onAdd = function (map) {
                        const div = L.DomUtil.create('div', 'legend');
                        div.innerHTML = legendContent;
                        L.DomEvent.disableClickPropagation(div); // Prevent map clicks
                        makeDraggable(div);
                        return div;
                    };
                    legendControl.addTo(map);
                }
            }
        }
        function getLegendHTML() {
            let html = `<div class="legend-header">圖例</div><div class="legend-content">`;
            const climateGroups = {
                'A: 熱帶': ['Af', 'Am', 'Aw'], 'B: 乾燥': ['BWh', 'BWk', 'BSh', 'BSk'],
                'C: 溫帶': ['Cfa', 'Cfb', 'Cfc', 'Csa', 'Csb', 'Cwa', 'Cwb'],
                'D: 寒帶': ['Dfa', 'Dfb', 'Dfc', 'Dfd', 'Dwa', 'Dwb', 'Dwc', 'Dwd'],
                'E: 極地': ['ET', 'EF']
            };
            for (const groupName in climateGroups) {
                html += `<h4>${groupName}</h4>`;
                climateGroups[groupName].forEach(typeCode => {
                    const climateDetail = koppenColorData[typeCode];
                    if (climateDetail) { html += `<i style="background:${climateDetail.color}"></i> ${typeCode}: ${climateDetail.name}<br>`; }
                });
            }
            html += `</div>`;
            return html;
        }
        function makeDraggable(element) {
            const header = element.querySelector('.legend-header');
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            header.onmousedown = dragMouseDown;
            function dragMouseDown(e) {
                e.preventDefault();
                pos3 = e.clientX; pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }
            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
                pos3 = e.clientX; pos4 = e.clientY;
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }
            function closeDragElement() {
                document.onmouseup = null; document.onmousemove = null;
            }
        }
        window.addEventListener('resize', setupLegend);

        // Initialize App
        setupLegend();
        initSandbox();
        updateInfoPanel(allCityKeys[0]); // Start with the first city in the sorted list

    </script>
</body>
</html>
