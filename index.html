<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>互動式柯本氣候學習平台</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js for interactive maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Chart.js for climographs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Custom font and base styling */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        #map {
            height: 100%; /* Map will fill its container's height */
            width: 100%;
            cursor: grab;
            background-color: #1e293b; /* A dark background for satellite tiles */
        }
        /* Custom styles for Leaflet legend */
        .legend {
            padding: 8px 12px;
            font: 13px/1.5 'Noto Sans TC', Arial, Helvetica, sans-serif;
            background: rgba(255,255,255,0.85);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 8px;
            line-height: 20px; 
            color: #333;
            max-height: 40vh; /* Set a max-height for mobile */
            overflow-y: auto;
        }
        .legend h4 {
            font-weight: bold;
            margin: 8px 0 5px 0;
            font-size: 14px;
        }
        .legend h4:first-child {
            margin-top: 0;
        }
        .legend i {
            width: 16px; 
            height: 16px; 
            float: left;
            margin-right: 8px;
            opacity: 0.8; 
            border-radius: 4px;
        }
        /* Custom class for enlarged city labels */
        .city-label-tooltip {
            font-size: 14px !important;
            font-weight: 500;
            padding: 4px 8px;
            background-color: rgba(255, 255, 255, 0.9);
            border-color: rgba(0,0,0,0.2);
        }
        /* Style for selected city in dropdown */
        select option:checked {
            background-color: #3b82f6;
            color: #ffffff;
        }
        /* Style for the analysis box */
        #climate-analysis, #quiz-answer-info {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: #f3f4f6;
            border-left: 4px solid #3b82f6;
            font-size: 0.875rem;
            line-height: 1.5;
            color: #374151;
        }
        #climate-analysis h5, #quiz-answer-info h5 {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #1f2937;
        }
        /* Quiz Styles */
        #quiz-container {
            border-top: 1px solid #e5e7eb;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
        }
        .quiz-option {
            display: block;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .quiz-option:hover {
            background-color: #f9fafb;
        }
        .quiz-option.selected {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }
        #quiz-feedback {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-weight: 500;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100">

    <!-- FIX: Responsive Flex Container -->
    <div class="flex flex-col lg:flex-row">
        <!-- Map container -->
        <!-- FIX: Set explicit height for mobile, full height for desktop -->
        <div class="w-full lg:w-2/3 h-96 lg:h-screen">
            <div id="map"></div>
        </div>

        <!-- Information and Climograph Panel -->
        <!-- FIX: Allow natural height and scrolling on mobile -->
        <div class="w-full lg:w-1/3 bg-white shadow-lg overflow-y-auto lg:h-screen">
            <div class="p-6">
                <!-- Main View -->
                <div id="main-view">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">互動式柯本氣候學習平台</h1>
                    <p class="text-gray-600 mb-4">請在地圖上點擊城市圖標，或從下方選單選擇一個城市，以查看其詳細氣候資料與氣候圖。</p>
                    
                    <!-- FIX: Mobile-only Legend Container -->
                    <div id="mobile-legend-container" class="lg:hidden mb-4"></div>

                    <div class="mb-4">
                        <label for="city-selector" class="block text-sm font-medium text-gray-700 mb-1">選擇城市:</label>
                        <select id="city-selector" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
                    </div>
                    <div id="city-info" class="bg-gray-50 p-4 rounded-lg">
                        <h2 id="city-name" class="text-xl font-bold text-blue-600"></h2>
                        <p id="climate-type" class="text-md font-semibold text-gray-700 mt-1"></p>
                        <p id="climate-description" class="text-sm text-gray-600 mt-2 h-16"></p>
                    </div>
                    <div id="annual-stats" class="grid grid-cols-2 gap-4 mt-4 text-center">
                        <div>
                            <p class="text-sm text-gray-500">年均溫</p>
                            <p id="annual-temp" class="text-lg font-bold text-red-600"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">年總降水量</p>
                            <p id="annual-precip" class="text-lg font-bold text-blue-600"></p>
                        </div>
                    </div>
                    <div class="mt-2">
                         <canvas id="climate-chart"></canvas>
                    </div>
                    <div id="climate-analysis"></div>
                </div>

                <!-- Quiz View -->
                <div id="quiz-view" class="hidden">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">氣候判讀練習</h1>
                    <p class="text-gray-600 mb-4">請根據下方的氣候圖，判斷其所屬的柯本氣候類型。</p>
                    <div>
                        <canvas id="quiz-chart"></canvas>
                    </div>
                    <div id="quiz-options" class="mt-4"></div>
                    <div id="quiz-feedback"></div>
                    <div id="quiz-answer-info" class="hidden"></div>

                    <div class="mt-4 flex space-x-2">
                        <button id="submit-answer" class="w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-600">提交答案</button>
                        <button id="next-question" class="w-full bg-gray-500 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-600 hidden">下一題</button>
                    </div>
                </div>

                 <!-- Quiz Start/End Button Container -->
                <div id="quiz-container" class="mt-6 border-t pt-6">
                    <button id="toggle-quiz-btn" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600">開始隨機練習</button>
                </div>

                <!-- Footer with author and version -->
                <footer class="mt-8 pt-4 border-t text-center text-xs text-gray-500">
                    <p>製作：鄭伉妙，版本1.0 (2025/06)</p>
                </footer>

            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const cityData = {
            // Taiwan Cities
            "Taipei": { name: "臺北 (臺灣)", lat: 25.0330, lon: 121.5654, type: "Cfa", temps: [16.6, 17.0, 18.9, 22.3, 25.6, 28.1, 29.5, 29.2, 27.4, 24.5, 21.8, 18.2], precip: [86, 143, 169, 148, 209, 292, 226, 269, 311, 145, 87, 80] },
            "Taichung": { name: "臺中 (臺灣)", lat: 24.1477, lon: 120.6736, type: "Cwa", temps: [16.8, 17.6, 19.9, 23.4, 26.3, 27.9, 28.6, 28.2, 27.5, 25.2, 22.1, 18.5], precip: [27, 49, 62, 91, 211, 370, 297, 303, 169, 17, 16, 20] },
            "Kaohsiung": { name: "高雄 (臺灣)", lat: 22.6273, lon: 120.3014, type: "Aw", temps: [20.2, 21.0, 23.3, 26.0, 28.1, 28.9, 29.2, 28.7, 28.2, 26.9, 24.5, 21.5], precip: [12, 18, 30, 52, 155, 395, 381, 399, 224, 43, 19, 12] },
            "Hualien": { name: "花蓮 (臺灣)", lat: 23.9781, lon: 121.6054, type: "Cfa", temps: [18.3, 18.8, 20.6, 23.2, 25.7, 27.7, 29.0, 28.6, 27.1, 24.9, 22.4, 19.7], precip: [59, 81, 84, 98, 184, 214, 250, 314, 350, 222, 121, 68] },
            "Yushan": { name: "玉山 (臺灣)", lat: 23.47, lon: 120.96, type: "ET", temps: [-0.5, 0.1, 2.1, 4.2, 6.2, 7.5, 8.2, 8.1, 7.5, 5.8, 3.5, 1.1], precip: [85, 120, 150, 260, 410, 630, 600, 550, 420, 150, 70, 65] },
            // A climates
            "Singapore": { name: "新加坡", lat: 1.3521, lon: 103.8198, type: "Af", temps: [26.5, 26.9, 27.2, 27.5, 27.5, 27.4, 27.1, 27.0, 27.0, 27.1, 26.8, 26.5], precip: [243, 163, 193, 184, 178, 175, 169, 197, 178, 208, 252, 289] },
            "Toamasina": { name: "圖阿馬西納 (馬達加斯加)", lat: -18.15, lon: 49.42, type: "Af", temps: [26.5, 26.6, 26.1, 25.2, 23.6, 22.0, 21.4, 21.6, 22.4, 23.7, 25.1, 26.2], precip: [410, 400, 451, 301, 230, 246, 276, 191, 131, 100, 131, 261] },
            "Cairns": { name: "凱恩斯 (澳)", lat: -16.92, lon: 145.77, type: "Am", temps: [27.6, 27.5, 26.9, 25.7, 24.0, 22.4, 21.8, 22.6, 23.9, 25.5, 26.8, 27.6], precip: [404, 452, 423, 196, 88, 48, 29, 35, 37, 48, 93, 180] },
            "Darwin": { name: "達爾文 (澳)", lat: -12.46, lon: 130.84, type: "Aw", temps: [28.3, 28.1, 28.5, 29.3, 28.5, 26.6, 26.0, 26.9, 28.8, 29.8, 29.8, 29.1], precip: [426, 372, 316, 101, 21, 2, 1, 5, 16, 57, 141, 252] },
            // B climates
            "Cairo": { name: "開羅 (埃)", lat: 30.0444, lon: 31.2357, type: "BWh", temps: [13.9, 15.0, 17.8, 22.0, 25.8, 28.1, 28.7, 28.5, 26.4, 23.9, 19.4, 15.3], precip: [5, 3, 2, 1, 0, 0, 0, 0, 0, 1, 3, 5] },
            "AliceSprings": { name: "愛麗斯泉 (澳)", lat: -23.70, lon: 133.88, type: "BWh", temps: [28.8, 27.9, 25.0, 20.3, 15.6, 12.4, 12.2, 14.8, 19.3, 23.9, 26.5, 28.2], precip: [40, 44, 32, 16, 19, 14, 21, 9, 9, 22, 29, 38] },
            "Toliara": { name: "圖利亞拉 (馬達加斯加)", lat: -23.35, lon: 43.67, type: "BSh", temps: [27.5, 27.5, 26.7, 24.7, 22.2, 20.1, 19.8, 20.8, 22.7, 24.9, 26.3, 27.2], precip: [93, 86, 36, 11, 16, 17, 7, 5, 8, 9, 20, 97] },
            "Turpan": { name: "吐魯番 (中)", lat: 42.91, lon: 89.19, type: "BWk", temps: [-7.6, -1.9, 8.7, 19.8, 26.5, 31.4, 33.0, 31.3, 25.0, 14.9, 3.8, -5.3], precip: [1, 1, 2, 3, 5, 8, 10, 8, 4, 2, 1, 1] },
            "Ndjamena": { name: "恩賈梅納 (查)", lat: 12.13, lon: 15.05, type: "BSh", temps: [23.3, 26.2, 30.3, 33.5, 32.9, 30.9, 28.3, 27.0, 27.9, 29.8, 27.1, 24.2], precip: [0, 0, 0, 10, 26, 60, 150, 255, 95, 20, 1, 0] },
            "ElPaso": { name: "巴索 (美)", lat: 31.7619, lon: -106.4850, type: "BSk", temps: [7.8, 10.8, 14.7, 19.2, 23.9, 28.3, 28.1, 26.9, 23.9, 18.3, 11.9, 7.9], precip: [11, 8, 5, 5, 5, 20, 41, 44, 34, 17, 8, 12] },
            // C climates
            "Perth": { name: "伯斯 (澳)", lat: -31.95, lon: 115.86, type: "Csa", temps: [24.5, 24.8, 22.9, 19.4, 16.0, 13.6, 12.8, 13.3, 15.0, 17.2, 20.1, 22.7], precip: [10, 12, 19, 36, 88, 125, 145, 126, 88, 40, 22, 11] },
            "SanFrancisco": { name: "舊金山 (美)", lat: 37.77, lon: -122.41, type: "Csb", temps: [10.6, 12.2, 13.1, 14.1, 15.1, 16.4, 16.9, 17.3, 17.6, 16.6, 13.6, 10.9], precip: [114, 113, 83, 37, 18, 4, 0, 1, 4, 29, 80, 116] },
            "Kunming": { name: "昆明 (中)", lat: 25.04, lon: 102.71, type: "Cwb", temps: [9.2, 11.2, 14.6, 17.7, 19.7, 20.3, 19.8, 19.3, 17.5, 15.0, 11.6, 8.8], precip: [12, 16, 20, 25, 90, 180, 205, 200, 120, 80, 40, 12] },
            "Sydney": { name: "雪梨 (澳)", lat: -33.86, lon: 151.20, type: "Cfa", temps: [23.0, 23.0, 21.7, 18.9, 15.7, 13.1, 12.2, 13.3, 15.6, 18.2, 20.0, 21.9], precip: [102, 119, 129, 126, 121, 132, 97, 81, 69, 77, 84, 78] },
            "Melbourne": { name: "墨爾本 (澳)", lat: -37.8136, lon: 144.9631, type: "Cfb", temps: [20.3, 20.2, 18.5, 15.6, 12.9, 10.8, 10.1, 11.2, 12.9, 14.8, 16.8, 18.7], precip: [47, 47, 51, 57, 56, 49, 48, 50, 58, 66, 60, 59] },
            "Reykjavik": { name: "雷克雅維克 (冰)", lat: 64.14, lon: -21.94, type: "Cfc", temps: [-0.5, 0.4, 0.5, 2.9, 6.3, 9.0, 10.6, 10.3, 7.4, 4.4, 1.1, -0.2], precip: [76, 72, 71, 58, 44, 50, 52, 67, 86, 86, 73, 94] },
            "Chicago": { name: "芝加哥 (美)", lat: 41.87, lon: -87.62, type: "Dfa", temps: [-3.8, -1.8, 3.8, 9.8, 15.7, 21.2, 23.8, 22.9, 18.6, 11.7, 4.8, -2.1], precip: [52, 47, 63, 86, 96, 94, 94, 107, 82, 80, 80, 57] },
            "Moscow": { name: "莫斯科 (俄)", lat: 55.7558, lon: 37.6173, type: "Dfb", temps: [-9.3, -8.3, -2.8, 5.8, 13.1, 16.9, 18.7, 16.9, 11.2, 5.1, -1.2, -6.1], precip: [42, 36, 34, 38, 52, 75, 88, 77, 60, 60, 52, 46] },
            "Anchorage": { name: "安克拉治 (美)", lat: 61.21, lon: -149.90, type: "Dfc", temps: [-8.3, -6.6, -2.7, 3.3, 9.3, 13.4, 15.3, 14.1, 9.4, 2.1, -4.8, -7.2], precip: [20, 19, 16, 12, 18, 29, 46, 62, 76, 54, 30, 29] },
            "Yakutsk": { name: "雅庫次克 (俄)", lat: 62.0355, lon: 129.6754, type: "Dwd", temps: [-38.6, -33.8, -20.1, -4.8, 7.5, 16.4, 19.5, 15.2, 5.9, -7.8, -27.3, -37.7], precip: [9, 8, 6, 9, 20, 35, 39, 37, 31, 21, 16, 10] },
            "Godthaab": { name: "努克 (格陵蘭)", lat: 64.1836, lon: -51.7216, type: "ET", temps: [-8.0, -8.5, -8.1, -2.8, 2.5, 6.1, 8.5, 8.0, 4.9, 0.3, -3.1, -6.2], precip: [40, 42, 49, 49, 55, 62, 82, 89, 81, 62, 60, 48] },
            "VostokStation": { name: "東方站 (南極)", lat: -78.46, lon: 106.86, type: "EF", temps: [-32.1, -44.3, -57.9, -64.7, -65.6, -65.2, -66.9, -67.6, -66.0, -57.1, -43.1, -32.1], precip: [1, 1, 2, 2, 3, 2, 2, 2, 2, 2, 1, 1] }
        };
        
        const koppenColorData = {
            'Af': { gridcode: 1, name: '熱帶雨林', color: '#669966', description: '終年高溫多雨，無明顯乾季。'},
            'Am': { gridcode: 2, name: '熱帶季風', color: '#7DB47D', description: '終年高溫，有短暫乾季。'},
            'Aw': { gridcode: 3, name: '熱帶莽原', color: '#99CC99', description: '終年高溫，乾濕季分明。'},
            'BWh': { gridcode: 4, name: '熱帶沙漠', color: '#FFCC66', description: '終年炎熱乾燥，降水稀少。'},
            'BWk': { gridcode: 5, name: '溫帶沙漠', color: '#FFE066', description: '冬冷夏熱，全年乾燥。'},
            'BSh': { gridcode: 6, name: '熱帶草原', color: '#FFDB4D', description: '終年高溫，降水較沙漠略多。'},
            'BSk': { gridcode: 7, name: '溫帶草原', color: '#FFFACD', description: '冬冷夏熱，半乾燥氣候。'},
            'Csa': { gridcode: 8, name: '地中海夏熱', color: '#CCCC66', description: '夏熱乾，冬溫雨。'},
            'Csb': { gridcode: 9, name: '地中海夏涼', color: '#D9D977', description: '夏涼乾，冬溫雨。'},
            'Cwa': { gridcode: 11, name: '溫帶冬乾夏熱', color: '#99CC00', description: '夏熱多雨，冬溫少雨。'},
            'Cwb': { gridcode: 12, name: '溫帶冬乾夏涼', color: '#AAFF00', description: '夏涼多雨，冬溫少雨。'},
            'Cfa': { gridcode: 14, name: '溫帶濕潤夏熱', color: '#999966', description: '夏熱多雨，冬溫濕潤。'},
            'Cfb': { gridcode: 15, name: '溫帶海洋性', color: '#B3B38C', description: '冬溫夏涼，全年有雨。'},
            'Cfc': { gridcode: 16, name: '副極地海洋性', color: '#CCCCA3', description: '無明顯夏季，冬溫濕潤。'},
            'Dfa': { gridcode: 25, name: '濕潤大陸夏熱(溫帶大陸性氣候)', color: '#9999CC', description: '夏熱冬寒，四季分明。'},
            'Dfb': { gridcode: 26, name: '濕潤大陸夏涼(溫帶大陸性氣候)', color: '#A8A8D6', description: '夏涼冬寒，四季分明。'},
            'Dfc': { gridcode: 27, name: '亞寒帶', color: '#B8B8E0', description: '夏短涼，冬長嚴寒。'},
            'Dfd': { gridcode: 28, name: '亞寒帶(嚴冬)', color: '#C8C8EA', description: '夏短涼，冬極嚴寒。'},
            'Dwa': { gridcode: 21, name: '季風大陸夏熱', color: '#B399CC', description: '夏熱多雨，冬寒乾燥。'},
            'Dwb': { gridcode: 22, name: '季風大陸夏涼', color: '#C2A8D6', description: '夏涼多雨，冬寒乾燥。'},
            'Dwc': { gridcode: 23, name: '季風亞寒帶', color: '#D1B8E0', description: '夏短涼雨，冬長嚴寒乾燥。'},
            'Dwd': { gridcode: 24, name: '季風亞寒帶(嚴冬)', color: '#E0C8EA', description: '夏短涼雨，冬極嚴寒乾燥。'},
            'ET': { gridcode: 29, name: '苔原氣候', color: '#CCCCCC', description: '終年嚴寒，夏短暫且涼。'},
            'EF': { gridcode: 30, name: '冰原氣候', color: '#F0F0F0', description: '終年酷寒，長年冰封。'}
        };

        // --- MAP INITIALIZATION ---
        const map = L.map('map', { zoomControl: true }).setView([23.973875, 120.982025], 7); // Center on Taiwan
        map.zoomControl.setPosition('topleft');
        
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        }).addTo(map);

        // --- CHART & UI VARIABLES ---
        const mainCtx = document.getElementById('climate-chart').getContext('2d');
        const quizCtx = document.getElementById('quiz-chart').getContext('2d');
        let mainClimateChart, quizClimateChart, quizAnswerMarker;
        let currentQuizKey = null;

        // --- CHART RENDERING FUNCTION ---
        function createOrUpdateClimateChart(ctx, cityData, chartInstance) {
            const months = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];
            if (chartInstance) { chartInstance.destroy(); }
            return new Chart(ctx, {
                type: 'bar', data: { labels: months, datasets: [
                        { type: 'line', label: '溫度 (°C)', data: cityData.temps, borderColor: '#ef4444', backgroundColor: '#ef4444', yAxisID: 'yTemp', tension: 0.3, borderWidth: 2 },
                        { type: 'bar', label: '降水量 (mm)', data: cityData.precip, backgroundColor: '#3b82f6', borderColor: '#3b82f6', yAxisID: 'yPrecip', }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: true, plugins: { title: { display: true, text: `${cityData.name || '匿名'} 氣候圖`, font: { size: 16, family: "'Noto Sans TC', sans-serif" } }, legend: { display: true, position: 'bottom' } },
                    scales: { x: { title: { display: true, text: '月份', font: { size: 12, family: "'Noto Sans TC', sans-serif" } } },
                        yTemp: { type: 'linear', position: 'left', title: { display: true, text: '氣溫 (°C)', font: { size: 12, family: "'Noto Sans TC', sans-serif" } }, grid: { drawOnChartArea: false } },
                        yPrecip: { type: 'linear', position: 'right', title: { display: true, text: '降水量 (mm)', font: { size: 12, family: "'Noto Sans TC', sans-serif" } }, }
                    }
                }
            });
        }

        // --- UI UPDATE FUNCTION ---
        function updateInfoPanel(cityKey) {
            const city = cityData[cityKey];
            const climateDetail = koppenColorData[city.type] || { name: '未知類型', description: '無詳細資料。' };
            document.getElementById('city-name').textContent = city.name;
            document.getElementById('climate-type').textContent = `${climateDetail.name} (${city.type})`;
            document.getElementById('climate-description').textContent = climateDetail.description;
            const totalPrecip = city.precip.reduce((a, b) => a + b, 0);
            const avgTemp = city.temps.reduce((a, b) => a + b, 0) / city.temps.length;
            document.getElementById('annual-precip').textContent = `${totalPrecip.toFixed(0)} mm`;
            document.getElementById('annual-temp').textContent = `${avgTemp.toFixed(1)} °C`;
            mainClimateChart = createOrUpdateClimateChart(mainCtx, city, mainClimateChart);
            document.getElementById('city-selector').value = cityKey;
            generateAnalysis(city, document.getElementById('climate-analysis'));
        }

        // --- CLIMATE ANALYSIS LOGIC ---
        function generateAnalysis(city, container) {
            const { temps, precip, lat, type } = city;
            const minTemp = Math.min(...temps);
            const maxTemp = Math.max(...temps);
            const totalPrecip = precip.reduce((a,b) => a + b, 0);
            let analysisHtml = `<h5>判讀依據分析</h5>`;
            let tempAnalysis = '', precipAnalysis = '';
            
            if (type.startsWith('E')) { tempAnalysis = maxTemp < 0 ? `最暖月均溫 ${maxTemp.toFixed(1)}°C 仍在冰點以下，屬於極地冰原氣候(EF)。` : `最暖月均溫 ${maxTemp.toFixed(1)}°C 介於 0-10°C 之間，屬於極地苔原氣候(ET)。`; } 
            else if (type.startsWith('A')) { tempAnalysis = `最冷月均溫 ${minTemp.toFixed(1)}°C 高於 18°C，屬於熱帶氣候(A)。`; } 
            else if (type.startsWith('C')) { tempAnalysis = `最冷月均溫 ${minTemp.toFixed(1)}°C 介於 -3°C 至 18°C 之間，屬於溫帶氣候(C)。`; } 
            else if (type.startsWith('D')) { tempAnalysis = `最冷月均溫 ${minTemp.toFixed(1)}°C 低於 -3°C，屬於寒帶氣候(D)。`; } 
            else { tempAnalysis = `此地年均溫與降水量的關係符合乾燥氣候的定義，優先判斷為乾燥氣候(B)。`; }

            const precipType = type.length > 1 ? type[1] : ''; 

            if (type.startsWith('B')) { precipAnalysis = `年總降水量僅 ${totalPrecip.toFixed(0)} mm，非常稀少。`; } 
            else if (type.startsWith('E')) { precipAnalysis = `全年低溫，降水稀少（年約 ${totalPrecip.toFixed(0)} mm），且多為固態降雪。`; } 
            else {
                 switch (precipType) {
                    case 'f': precipAnalysis = `降水季節分布相對均勻，無明顯乾季(f)。`; break;
                    case 's': precipAnalysis = `夏季(${lat > 0 ? '6-8月':'12-2月'})乾燥，冬季多雨，呈現夏乾冬雨(s)的型態。`; break;
                    case 'w': precipAnalysis = `冬季(${lat > 0 ? '12-2月':'6-8月'})乾燥，夏季多雨，呈現冬乾夏雨(w)的型態。`; break;
                    case 'm': precipAnalysis = `降水型態介於雨林與莽原之間，屬於熱帶季風(m)型。`; break;
                    default: precipAnalysis = `降水季節分布較為特殊。`; break;
                 }
            }
            analysisHtml += `<p><b>1. 氣溫判讀：</b>${tempAnalysis}</p>`;
            analysisHtml += `<p><b>2. 降水判讀：</b>${precipAnalysis}</p>`;
            analysisHtml += `<p><b>3. 綜合結論：</b>結合氣溫與降水特徵，此地氣候類型為 <b>${type} (${koppenColorData[type].name})</b>。</p>`;
            container.innerHTML = analysisHtml;
        }

        // --- ADDING CITY MARKERS AND POPULATING SELECTOR ---
        const selector = document.getElementById('city-selector');
        Object.keys(cityData).forEach(key => {
            const city = cityData[key];
            const markerColor = koppenColorData[city.type] ? koppenColorData[city.type].color : '#808080';
            const customIcon = L.divIcon({ className: 'custom-div-icon', html: `<div style="background-color:${markerColor};" class="w-5 h-5 rounded-full border-2 border-white shadow-xl"></div>`, iconSize: [20, 20], iconAnchor: [10, 10] });
            const marker = L.marker([city.lat, city.lon], { icon: customIcon }).addTo(map);
            marker.bindTooltip(city.name, { permanent: false, direction: 'top', offset: [0, -10], className: 'city-label-tooltip' });
            marker.on('click', () => { if (document.getElementById('main-view').style.display !== 'none') { map.setView([city.lat, city.lon], 7); updateInfoPanel(key); } });
            const option = document.createElement('option');
            option.value = key; option.textContent = `${city.name} (${city.type})`;
            selector.appendChild(option);
        });
        
        selector.addEventListener('change', (event) => { const cityKey = event.target.value; const city = cityData[cityKey]; map.setView([city.lat, city.lon], 7); updateInfoPanel(cityKey); });
        
        // --- ADDING KÖPPEN CLIMATE GEOJSON LAYER ---
        const climateJsonUrl = 'https://gist.githubusercontent.com/gemini-generative-ai/e4bf815ab9c342d4a572242c73d9319e/raw/33a18a803f26a111244e883e449a04f2d3fcb00f/koppen_climate.geojson';
        fetch(climateJsonUrl).then(res => res.json()).then(data => {
            L.geoJson(data, { style: feature => { const gridcode = feature.properties.GRIDCODE; const climateType = Object.values(koppenColorData).find(d => d.gridcode === gridcode); const fillColor = climateType ? climateType.color : 'transparent'; return { fillColor, fillOpacity: 0.65, weight: 0 }; }, interactive: false }).addTo(map);
            Object.values(map._layers).forEach(layer => { if (layer instanceof L.Marker) { layer.bringToFront(); } });
        });

        // --- ADDING LATITUDE LINES ---
        const latLines = [
            { lat: 60, label: '北緯 60°' }, { lat: 40, label: '北緯 40°' },
            { lat: 23.5, label: '北回歸線 23.5°' }, { lat: 0, label: '赤道 0°' },
            { lat: -23.5, label: '南回歸線 23.5°' }, { lat: -40, label: '南緯 40°' },
            { lat: -60, label: '南緯 60°' }
        ];
        const lineStyle = { color: 'rgba(255, 255, 255, 0.7)', weight: 1.5, dashArray: '5, 10' };
        latLines.forEach(line => {
            L.polyline([[line.lat, -180], [line.lat, 180]], lineStyle).addTo(map);
            L.marker([line.lat, -150], { icon: L.divIcon({ className: 'lat-label', html: `<span>${line.label}</span>` }) }).addTo(map);
        });

        // --- LEGEND ---
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'info legend');
            const climateGroups = {
                'A: 熱帶': ['Af', 'Am', 'Aw'], 'B: 乾燥': ['BWh', 'BWk', 'BSh', 'BSk'],
                'C: 溫帶': ['Cfa', 'Cfb', 'Csa', 'Csb', 'Cwa', 'Cwb', 'Cfc'],
                'D: 寒帶': ['Dfa', 'Dfb', 'Dfc', 'Dfd', 'Dwa', 'Dwb', 'Dwc', 'Dwd'],
                'E: 極地': ['ET', 'EF']
            };
            for (const groupName in climateGroups) {
                div.innerHTML += `<h4>${groupName}</h4>`;
                climateGroups[groupName].forEach(typeCode => {
                    const climateDetail = koppenColorData[typeCode];
                    if (climateDetail) { div.innerHTML += `<i style="background:${climateDetail.color}"></i> ${typeCode}: ${climateDetail.name}<br>`; }
                });
            }
            return div;
        };
        legend.addTo(map);
        
        // --- QUIZ LOGIC ---
        const toggleQuizBtn = document.getElementById('toggle-quiz-btn');
        const mainView = document.getElementById('main-view');
        const quizView = document.getElementById('quiz-view');
        const submitBtn = document.getElementById('submit-answer');
        const nextBtn = document.getElementById('next-question');

        toggleQuizBtn.addEventListener('click', () => {
            const isQuizActive = mainView.style.display === 'none';
            if (!isQuizActive) {
                loadNewQuestion();
                mainView.style.display = 'none';
                quizView.style.display = 'block';
                toggleQuizBtn.textContent = '結束練習';
                toggleQuizBtn.classList.replace('bg-green-500', 'bg-red-500');
                toggleQuizBtn.classList.replace('hover:bg-green-600', 'hover:bg-red-600');
            } else {
                mainView.style.display = 'block';
                quizView.style.display = 'none';
                toggleQuizBtn.textContent = '開始隨機練習';
                toggleQuizBtn.classList.replace('bg-red-500', 'bg-green-500');
                toggleQuizBtn.classList.replace('hover:bg-red-600', 'hover:bg-green-600');
                if (quizAnswerMarker) { map.removeLayer(quizAnswerMarker); quizAnswerMarker = null; }
                map.setView([23.973875, 120.982025], 7); 
            }
        });
        
        function setupQuizOptionsListeners() {
            const options = document.querySelectorAll('.quiz-option');
            options.forEach(option => {
                option.addEventListener('click', () => {
                    options.forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });
        }
        
        function loadNewQuestion() {
            if (quizAnswerMarker) { map.removeLayer(quizAnswerMarker); quizAnswerMarker = null; }
            const cityKeys = Object.keys(cityData);
            currentQuizKey = cityKeys[Math.floor(Math.random() * cityKeys.length)];
            const city = cityData[currentQuizKey];
            quizClimateChart = createOrUpdateClimateChart(quizCtx, { ...city, name: '匿名' }, quizClimateChart);
            const correctAnswer = city.type;
            const options = new Set([correctAnswer]);
            const allTypes = Object.keys(koppenColorData);
            while(options.size < 4) { const randomType = allTypes[Math.floor(Math.random() * allTypes.length)]; options.add(randomType); }
            const shuffledOptions = Array.from(options).sort(() => Math.random() - 0.5);
            const optionsContainer = document.getElementById('quiz-options');
            optionsContainer.innerHTML = '';
            shuffledOptions.forEach(opt => {
                optionsContainer.innerHTML += `<label class="quiz-option"><input type="radio" name="quiz" value="${opt}" class="sr-only"> ${opt}: ${koppenColorData[opt].name}</label>`;
            });
            setupQuizOptionsListeners();
            submitBtn.disabled = false;
            submitBtn.style.display = 'inline-block';
            nextBtn.style.display = 'none';
            document.getElementById('quiz-feedback').innerHTML = '';
            document.getElementById('quiz-answer-info').style.display = 'none';
        }

        submitBtn.addEventListener('click', () => {
            const selected = document.querySelector('input[name="quiz"]:checked');
            if (!selected) { alert('請選擇一個答案！'); return; }

            const feedbackEl = document.getElementById('quiz-feedback');
            const answerInfoEl = document.getElementById('quiz-answer-info');
            const city = cityData[currentQuizKey];
            const correctAnswer = city.type;
            
            if (selected.value === correctAnswer) {
                feedbackEl.innerHTML = '答對了！';
                feedbackEl.className = 'text-green-600 bg-green-100 p-3 rounded-md font-bold';
            } else {
                feedbackEl.innerHTML = `答錯了，正確答案是 <b>${correctAnswer}: ${koppenColorData[correctAnswer].name}</b>`;
                feedbackEl.className = 'text-red-600 bg-red-100 p-3 rounded-md font-bold';
            }
            
            map.flyTo([city.lat, city.lon], 8); 
            if (quizAnswerMarker) { map.removeLayer(quizAnswerMarker); }
            quizAnswerMarker = L.circleMarker([city.lat, city.lon], {
                radius: 15,
                fillColor: koppenColorData[correctAnswer].color,
                color: "#fff",
                weight: 3,
                opacity: 1,
                fillOpacity: 0.8
            }).addTo(map);

            let fullAnswerText = `<h5>正確答案：${city.name}</h5>`;
            answerInfoEl.innerHTML = fullAnswerText;
            generateAnalysis(city, answerInfoEl);
            answerInfoEl.style.display = 'block';
            submitBtn.disabled = true;
            submitBtn.style.display = 'none';
            nextBtn.style.display = 'inline-block';
        });

        nextBtn.addEventListener('click', loadNewQuestion);

        // --- INITIAL LOAD ---
        const initialCityKey = "Taipei"; // Start with Taipei
        updateInfoPanel(initialCityKey);
    </script>
</body>
</html>
